<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - The Cryptic Legion</title>
    <link rel="icon" type="image/png" href="The_Cryptic_Legion_Logo__1_-removebg-preview.png" sizes="32x32">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Base Styles */
        :root { --montserrat: "Montserrat", sans-serif; --main: #ebd978; --main3: #101c32; --main4: #0c1525; --main5: #060b14; --white: #fff; --Vwhite: #e9e7e7; --dwhite: #cccccc; --bg1: #2e3267; --container-width-lg: 80%; --trensition: all 400ms ease; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--montserrat); line-height: 1.7; color: var(--white); background: var(--main4); }
        .container { width: var(--container-width-lg); margin: 0 auto; }
        h1, h2, h3 { line-height: 1.2; margin-bottom: 1rem; color: var(--Vwhite); }
        h1 { font-size: 2.5rem; text-align: center; margin: 2rem 0; padding-bottom: 1rem; border-bottom: 2px solid var(--bg1); }
        h2 { margin-top: 2.5rem; color: var(--main); }
        .btn { display: inline-block; padding: 12px 24px; margin-top: 1rem; color: var(--white); background: var(--main3); border-radius: 5px; cursor: pointer; text-align: center; border: none; font-size: 1rem; font-family: var(--montserrat); transition: var(--trensition); }
        .btn:hover { background: var(--bg1); }
        .btn-danger { background: #f75842; margin-left: 10px; }
        .btn-danger:hover { background: #e0432d; }
        .admin-section { background: var(--main5); padding: 2rem; margin-bottom: 2rem; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .management-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; }
        .item-card { background: var(--main3); border-radius: 8px; overflow: hidden; text-align: center; padding: 1rem; transition: var(--trensition); display: flex; flex-direction: column; justify-content: space-between; }
        .item-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .item-card img, .item-card video { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; margin-bottom: 1rem; }
        .item-card p { font-size: 0.9rem; color: var(--dwhite); margin-bottom: 1rem; flex-grow: 1; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--Vwhite); }
        .form-group input[type="file"], .form-group input[type="text"], .form-group textarea, .form-group input[type="password"] {
            width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--bg1); background: var(--main4); color: var(--white); font-family: var(--montserrat); 
        }
        .back-link { display: inline-block; margin: 2rem 0 0 2rem; color: var(--main); text-decoration: none; font-weight: 500; }
        .back-link i { margin-right: 8px; }
        @media screen and (max-width: 600px) {
            .management-grid { grid-template-columns: 1fr; }
        }

        /* --- LOGIN POPUP STYLES --- */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #login-popup {
            background: var(--main5);
            padding: 2.5rem;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        #login-popup h2 {
            color: var(--main);
            margin-bottom: 1.5rem;
        }
        
        /* --- PASSWORD TOGGLE STYLES (Peek Feature) --- */
        .password-container {
            position: relative;
        }

        .password-container input[type="password"],
        .password-container input[type="text"] {
            padding-right: 40px; 
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--dwhite);
            font-size: 1.2rem;
            transition: color 0.2s;
            z-index: 10;
            margin-top: 0.2rem;
        }
        
        .toggle-password:hover {
            color: var(--main);
        }

        /* ---------------------------------- */
        /* --- ANIMATION POPUP STYLES --- */
        /* ---------------------------------- */

        #status-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--main5);
            color: var(--white);
            padding: 2rem 3rem;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            display: none; /* Initially hidden */
            text-align: center;
            min-width: 200px;
        }

        .icon-box {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            color: var(--white);
        }

        /* Success Styles (Green Check) */
        .icon-box.success { background: #00a87a; }
        .icon-box.success i { 
            animation: bounceIn 0.5s ease-out; 
        }

        /* Failure Styles (Red X) */
        .icon-box.failure { background: #f75842; }
        .icon-box.failure i { 
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        
        /* Keyframe Animations */
        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div id="login-popup">
            <h2>Admin Login Required</h2>
            <div class="form-group">
                <label for="login-name">Name</label>
                <input type="text" id="login-name" placeholder="Enter Name" required>
            </div>
            <div class="form-group">
                <label for="login-password">Password</label>
                <div class="password-container">
                    <input type="password" id="login-password" placeholder="Enter Password" required>
                    <i class='bx bx-show toggle-password' id="toggle-password" onclick="togglePasswordVisibility()"></i>
                </div>
            </div>
            <button class="btn" id="login-button" onclick="handleLogin()">Login</button>
            <p id="login-error" style="display: none; color: #f75842; margin-top: 1rem; font-weight: 600;"></p>
        </div>
    </div>
    <div id="status-popup">
        <div id="status-icon-box" class="icon-box">
            <i id="status-icon" class='bx'></i>
        </div>
        <p id="status-message" style="font-size: 1.1rem; font-weight: 600;"></p>
    </div>
    <a href="index.html" class="back-link"><i class='bx bx-arrow-back'></i>Back to Home</a>
    <div class="container">
        <h1>Admin Control Panel</h1>

        <section class="admin-section">
            <h2>Manage Header Images</h2>
            <div id="header-images-grid" class="management-grid"></div>
            <div class="form-group">
                <label for="new-image-upload">Upload New Header Image</label>
                <input type="file" id="new-image-upload" accept="image/*">
                <button class="btn" onclick="addImage()">Add Image</button>
            </div>
        </section>

        <section class="admin-section">
            <h2>Manage Highlight Videos</h2>
            <div id="videos-grid" class="management-grid"></div>
            <div class="form-group">
                <label for="new-video-upload">Upload New Video</label>
                <input type="file" id="new-video-upload" accept="video/*">
            </div>
            <div class="form-group">
                <label for="new-video-description">Video Description</label>
                <input type="text" id="new-video-description" placeholder="e.g., Enzo Fernandez funny moment...">
            </div>
             <button class="btn" onclick="addVideo()">Add Video</button>
        </section>
        
        <section class="admin-section">
            <h2>Manage Live Reports / Testimonials</h2>
            <div id="testimonials-grid" class="management-grid"></div>
            <div class="form-group">
                <label for="new-testimonial-avatar">Avatar Image</label>
                <input type="file" id="new-testimonial-avatar" accept="image/*">
            </div>
            <div class="form-group">
                <label for="new-testimonial-name">Person's Name</label>
                <input type="text" id="new-testimonial-name" placeholder="e.g., David Okereke">
            </div>
            <div class="form-group">
                <label for="new-testimonial-role">Role</label>
                <input type="text" id="new-testimonial-role" placeholder="e.g., Football Analyst">
            </div>
            <div class="form-group">
                <label for="new-testimonial-body">Quote / Message</label>
                <textarea id="new-testimonial-body" rows="4" placeholder="Enter the testimonial message here..."></textarea>
            </div>
            <button class="btn" onclick="addTestimonial()">Add Testimonial</button>
        </section>
    </div>

    <script>
// --- SUPABASE CONFIGURATION ---
// !!! IMPORTANT: Replace with your actual Supabase details !!!
const SUPABASE_URL = 'https://hzduwqstaowpllqmuwrc.supabase.co'; // e.g., 'https://xyz.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6ZHV3cXN0YW93cGxscW11d3JjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NjM4NDgsImV4cCI6MjA3NDIzOTg0OH0.V0QQ_au79MtQ7T6p6uDn_c2xkMrIt2L5QwqF_InN9eM'; 

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const IMAGE_BUCKET = 'images'; // Define your Supabase storage bucket names
const VIDEO_BUCKET = 'videos';
const AVATAR_BUCKET = 'avatars';

// --- ANIMATION/STATUS POPUP LOGIC ---
const statusPopup = document.getElementById('status-popup');
const statusIconBox = document.getElementById('status-icon-box');
const statusIcon = document.getElementById('status-icon');
const statusMessage = document.getElementById('status-message');

/**
 * Displays an animated status popup (success or failure).
 * @param {boolean} success - True for success (check), false for failure (X). Null for 'transferring'.
 * @param {string} message - The message to display.
 */
const showStatusPopup = (success, message) => {
    // Basic check to prevent errors if the elements are somehow missing
    if (!statusPopup) {
        console.warn(`STATUS: ${message}`); 
        return; 
    }

    statusIconBox.className = 'icon-box'; // Reset classes
    statusIcon.className = 'bx'; // Reset icon class
    statusIconBox.style.backgroundColor = ''; // Clear custom transfer color

    if (success === true) {
        statusIconBox.classList.add('success');
        statusIcon.classList.add('bx-check');
    } else if (success === false) {
        statusIconBox.classList.add('failure');
        statusIcon.classList.add('bx-x');
    } else {
        // Yellow Transfer Sign (Transferring/Loading state)
        statusIconBox.style.backgroundColor = '#ebd978'; // yellow/main color
        statusIcon.classList.add('bx-loader-alt', 'bx-spin'); // Spinning icon
    }

    statusMessage.textContent = message;
    statusPopup.style.display = 'block';

    // Auto-hide the popup only for final success/failure states
    if (success !== null) {
        setTimeout(() => {
            statusPopup.style.display = 'none';
        }, 3000);
    }
};

// --- PASSWORD TOGGLE FUNCTION RE-ADDED (Peek Feature) ---
window.togglePasswordVisibility = () => {
    const passwordInput = document.getElementById('login-password');
    const toggleIcon = document.getElementById('toggle-password');
    
    const isPassword = passwordInput.type === 'password';
    passwordInput.type = isPassword ? 'text' : 'password';

    toggleIcon.className = isPassword ? 'bx bx-hide toggle-password' : 'bx bx-show toggle-password';
};


// --- LOGIN HANDLING RE-ADDED ---
const CORRECT_NAME = 'Slogan';
const CORRECT_PASSWORD = 'Wintersolider44';
const overlay = document.getElementById('login-overlay');
const errorDisplay = document.getElementById('login-error');

window.handleLogin = () => {
    const nameInput = document.getElementById('login-name').value;
    const passwordInput = document.getElementById('login-password').value;

    if (nameInput === CORRECT_NAME && passwordInput === CORRECT_PASSWORD) {
        overlay.style.display = 'none'; 
        errorDisplay.style.display = 'none';
        
        showStatusPopup(true, 'Login Successful! Welcome.');
        
        // Fetch and render data upon successful login
        fetchAndRender(IMAGE_TABLE, renderImages);
        fetchAndRender(VIDEO_TABLE, renderVideos);
        fetchAndRender(TESTIMONIAL_TABLE, renderTestimonials);

    } else {
        showStatusPopup(false, 'Login Failed. Check credentials.');
        errorDisplay.textContent = 'Invalid Name or Password. Please try again.';
        errorDisplay.style.display = 'block';
    }
};


// Helper to upload file to Supabase Storage
const uploadFileToSupabaseStorage = async (file, bucket) => {
    // Show yellow "transfer" sign during upload (Set success to null)
    showStatusPopup(null, 'Uploading file...'); 

    const filePath = `${Date.now()}-${file.name.replace(/\s/g, '_')}`;
    
    // Supabase upload call
    const { data, error } = await supabase.storage
        .from(bucket)
        .upload(filePath, file);

    // After upload attempt, we hide the status popup, the next call will re-show it
    if (statusPopup) statusPopup.style.display = 'none'; 

    if (error) {
        console.error("Supabase Upload Error:", error);
        throw new Error('Supabase upload failed: ' + error.message);
    }

    // Get the public URL for the file
    const { data: publicURLData } = supabase.storage
        .from(bucket)
        .getPublicUrl(filePath);
    
    return publicURLData.publicUrl;
};

// Helper to fetch all data from a table and render
const fetchAndRender = async (tableName, renderFunc) => {
    const { data, error } = await supabase
        .from(tableName)
        .select('*')
        .order('id', { ascending: false }); // Show newest first

    if (error) {
        console.error('Fetch Error:', error);
        return [];
    }
    renderFunc(data);
    return data;
};

document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const imagesGrid = document.getElementById('header-images-grid');
    const videosGrid = document.getElementById('videos-grid');
    const testimonialsGrid = document.getElementById('testimonials-grid');

    // Table Names
    const IMAGE_TABLE = 'crypticLegionImages';
    const VIDEO_TABLE = 'crypticLegionVideos';
    const TESTIMONIAL_TABLE = 'crypticLegionTestimonials';
    
    // --- RENDER FUNCTIONS (No changes needed here, they use the correct keys) ---
    const renderImages = (images) => {
        imagesGrid.innerHTML = '';
        images.forEach(image => {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `<img src="${image.src}" alt="Header Image"><button class="btn btn-danger" onclick="deleteItem('${IMAGE_TABLE}', ${image.id}, 'image')">Delete</button>`;
            imagesGrid.appendChild(card);
        });
    };

    const renderVideos = (videos) => {
        videosGrid.innerHTML = '';
        videos.forEach(video => {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `<video src="${video.src}" controls loop></video><p>${video.description}</p><button class="btn btn-danger" onclick="deleteItem('${VIDEO_TABLE}', ${video.id}, 'video')">Delete</button>`;
            videosGrid.appendChild(card);
        });
    };

    const renderTestimonials = (testimonials) => {
        testimonialsGrid.innerHTML = '';
        testimonials.forEach(t => {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `
                <div>
                    <img src="${t.avatarSrc}" alt="Avatar" style="width: 80px; height: 80px; border-radius: 50%;">
                    <h5>${t.name}</h5>
                    <small>${t.role}</small>
                    <p style="font-size: 0.8rem; margin-top: 1rem;">"${t.body}"</p>
                </div>
                <button class="btn btn-danger" onclick="deleteItem('${TESTIMONIAL_TABLE}', ${t.id}, 'testimonial')">Delete</button>`;
            testimonialsGrid.appendChild(card);
        });
    };

    // --- DELETE FUNCTION (Uses animated popup) ---
    window.deleteItem = async (tableName, id, type) => {
        if (confirm('Are you sure you want to delete this item? This will be removed from Supabase.')) {
            showStatusPopup(null, 'Deleting item...'); // Yellow transfer sign for deleting

            const { error } = await supabase
                .from(tableName)
                .delete()
                .eq('id', id);

            if (error) {
                showStatusPopup(false, `Deletion Failed: ${error.message}`);
                console.error('Deletion Error:', error);
            } else {
                showStatusPopup(true, 'Item deleted successfully!');
                if (type === 'image') await fetchAndRender(IMAGE_TABLE, renderImages);
                else if (type === 'video') await fetchAndRender(VIDEO_TABLE, renderVideos);
                else if (type === 'testimonial') await fetchAndRender(TESTIMONIAL_TABLE, renderTestimonials);
            }
        }
    };

    // --- ADD IMAGE FUNCTION (Uses animated popup) ---
    window.addImage = async () => {
        const imageInput = document.getElementById('new-image-upload');
        const file = imageInput.files[0];
        if (!file) { showStatusPopup(false, 'Please select an image file.'); return; }

        try {
            const downloadURL = await uploadFileToSupabaseStorage(file, IMAGE_BUCKET);
            
            const { error } = await supabase.from(IMAGE_TABLE).insert([{ src: downloadURL }]);
            
            if (error) throw new Error(error.message);

            imageInput.value = ''; 
            showStatusPopup(true, 'Image uploaded and saved successfully!');
            await fetchAndRender(IMAGE_TABLE, renderImages);

        } catch (error) {
            showStatusPopup(false, 'Image operation failed: ' + error.message);
        }
    };

    // --- ADD VIDEO FUNCTION (Uses animated popup) ---
    window.addVideo = async () => {
        const videoInput = document.getElementById('new-video-upload');
        const descInput = document.getElementById('new-video-description');
        const file = videoInput.files[0];
        if (!file || !descInput.value.trim()) { showStatusPopup(false, 'Select a video and add a description.'); return; }

        try {
            const downloadURL = await uploadFileToSupabaseStorage(file, VIDEO_BUCKET);

            const { error } = await supabase.from(VIDEO_TABLE).insert([{ src: downloadURL, description: descInput.value.trim() }]);
            
            if (error) throw new Error(error.message);

            videoInput.value = ''; 
            descInput.value = ''; 
            showStatusPopup(true, 'Video uploaded and saved successfully!');
            await fetchAndRender(VIDEO_TABLE, renderVideos);

        } catch (error) {
            showStatusPopup(false, 'Video operation failed: ' + error.message);
        }
    };
    
    // --- ADD TESTIMONIAL FUNCTION (Uses animated popup) ---
    window.addTestimonial = async () => {
        const avatarInput = document.getElementById('new-testimonial-avatar');
        const nameInput = document.getElementById('new-testimonial-name');
        const roleInput = document.getElementById('new-testimonial-role');
        const bodyInput = document.getElementById('new-testimonial-body');
        const file = avatarInput.files[0];

        if (!file || !nameInput.value.trim() || !roleInput.value.trim() || !bodyInput.value.trim()) {
            showStatusPopup(false, 'Please fill out all testimonial fields and select an avatar.'); return;
        }

        try {
            const avatarUrl = await uploadFileToSupabaseStorage(file, AVATAR_BUCKET);

            const newItem = {
                avatarSrc: avatarUrl,
                name: nameInput.value.trim(),
                role: roleInput.value.trim(),
                body: bodyInput.value.trim()
            };
            const { error } = await supabase.from(TESTIMONIAL_TABLE).insert([newItem]);

            if (error) throw new Error(error.message);
            
            avatarInput.value = nameInput.value = roleInput.value = bodyInput.value = '';
            showStatusPopup(true, 'Testimonial added and saved successfully!');
            await fetchAndRender(TESTIMONIAL_TABLE, renderTestimonials);

        } catch (error) {
            showStatusPopup(false, 'Testimonial operation failed: ' + error.message);
        }
    };
    
    // No initial data fetching on DOMContentLoaded since the login screen covers everything.
    // The data will be fetched upon successful login inside handleLogin().
});
    </script>
</body>
</html>
